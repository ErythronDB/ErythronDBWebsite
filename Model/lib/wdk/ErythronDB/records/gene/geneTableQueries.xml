<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>
	<querySet name="GeneTables" queryType="table" isCacheable="false">

		<!-- =================================================================== -->
		<!-- Gene Model -->
		<!-- =================================================================== -->

		<sqlQuery name="Transcripts">
			<column name="source_id"/>
			<column name="transcript_id"/>
			<column name="transcript_length"/>
			<column name="transcript_exon_count"/>
			<sql>
				<![CDATA[
		 SELECT gene_source_id AS source_id,
		 '@PROJECT_ID@'::text AS project_id,
		 transcript_source_id AS transcript_id,
		 transcript_length,
		 exon_count AS transcript_exon_count
		 FROM CBIL.TranscriptAttributes
	]]>
			</sql>
		</sqlQuery>

		<!-- =================================================================== -->
		<!-- Transcriptomics -->
		<!-- =================================================================== -->
	

		<!-- =================================================================== -->
		<!-- Proteomics -->
		<!-- =================================================================== -->

		<sqlQuery name="MassSpecMod">
			<column name="source_id"/>
			<column name="experiment"/>
			<column name="peptide"/>
			<column name="protein_id"/>
			<column name="modification_site"/>
			<column name="modification_type"/>
			<column name="molecular_weight"/>
			<column name="charge"/>
			<column name="mass_to_charge_ratio"/>
			<sql>
				<![CDATA[
		 SELECT ga.source_id,
		 '@PROJECT_ID@'::text AS project_id,
		 s.name AS experiment,
		 gp.peptide,
		 gp.protein_id,
		 gp.modification_site,
		 ot.name AS modification_type,
		 scores->>'kD' AS molecular_weight,
		 scores->>'Charge' AS charge,
		 round((scores->>'Calc m/Z')::numeric, 2) AS mass_to_charge_ratio
		 FROM
		 ErythronDB.GenePeptide gp,
		 Study.Study s,
		 CBIL.GeneAttributes ga,
		 SRes.OntologyTerm ot
		 WHERE s.study_id = gp.study_id
		 AND ga.gene_id = gp.gene_id
		 AND ot.ontology_term_id = gp.modification_type_id
	     AND NOT (@HIDE_PRIVATE_DATA@::boolean AND (s.approaches->>'public' IS NOT NULL AND (s.approaches->>'public')::boolean IS FALSE))
	]]>
			</sql>
		</sqlQuery>

		<sqlQuery name="MassSpecComparison">
			<column name="source_id"/>
			<column name="comparison"/>
			<column name="fold_change"/>
			<column name="adj_fold_change"/>
			<column name="alt_mean_intensity"/>
			<column name="ref_mean_intensity"/>
				<column name="peptide"/>
			<column name="protein_id"/>
			<sql>
				<![CDATA[
		 SELECT ga.source_id,
		  gp.peptide,
		 gp.protein_id,
		 '@PROJECT_ID@'::text AS project_id,
		 pan.name AS comparison,
		 CASE WHEN pc.fold_change = 'NaN' THEN pc.fold_change
		 ELSE round(pc.fold_change::numeric, 2)::float END AS fold_change,
		 CASE WHEN pc.adj_fold_change = 'NaN' THEN pc.adj_fold_change
		 ELSE round(pc.adj_fold_change::numeric, 2)::float END AS adj_fold_change,
		 CASE WHEN api.intensity > 1000 THEN to_char(round(api.intensity::numeric), '9.99EEEE')
		 ELSE round(api.intensity::numeric)::text END AS alt_mean_intensity,
		 CASE WHEN rpi.intensity > 1000 THEN to_char(round(rpi.intensity::numeric), '9.99EEEE')
		 ELSE round(rpi.intensity::numeric)::text END AS ref_mean_intensity
		 FROM
		 ErythronDB.PeptideComparison pc,
		 ErythronDB.GenePeptide gp,
		 ErythronDB.Comparison c,
		 CBIL.GeneAttributes ga,
		 ErythronDB.PeptideIntensity rpi,
		 ErythronDB.PeptideIntensity api,
		 Study.ProtocolAppNode pan,
		 Study.StudyLink sl,
		 Study.Study s
		 WHERE c.comparison_id = pc.comparison_id
		 AND gp.gene_peptide_id = pc.peptide_id
		 AND pan.protocol_app_node_id = c.protocol_app_node_id
		 AND gp.gene_id = ga.gene_id
		 AND c.reference_condition_id = rpi.protocol_app_node_id
		 AND rpi.peptide_id = gp.gene_peptide_id
		 AND c.alternative_condition_id = api.protocol_app_node_id
		 AND api.peptide_id = gp.gene_peptide_id
		 AND pan.protocol_app_node_id = sl.protocol_app_node_id
		 AND s.study_id = sl.study_id
		 AND NOT (@HIDE_PRIVATE_DATA@::boolean AND (s.approaches->>'public' IS NOT NULL AND (s.approaches->>'public')::boolean IS FALSE))
		 ORDER BY fold_change DESC
	]]>
			</sql>
		</sqlQuery>

		<!-- =================================================================== -->
		<!-- Functional Annotation -->
		<!-- =================================================================== -->
		<sqlQuery name="GO">
			<column name="source_id"/>
			<column name="go_term"/>
			<column name="go_id"/>
			<column name="ontology"/>
			<column name="definition"/>
			<column name="evidence_code"/>
			<sql>
				<![CDATA[
		 SELECT goa.source_id,
		 '@PROJECT_ID@'::text AS project_id,
		 go_term,
		 ot.definition,
		 replace(go_term_id, '_', ':') AS go_id,
		 evidence_code,
		 ontology_abbrev AS ontology
		 FROM CBIL.GoAssociation_TC goa,
		 SRes.OntologyTerm ot
		 WHERE evidence_code != 'closure'
		 AND ot.ontology_term_id = goa.ontology_term_id
		 ORDER BY ontology_abbrev, go_term
	]]>
			</sql>
		</sqlQuery>

		<!-- =================================================================== -->
		<!-- Link outs -->
		<!-- =================================================================== -->

		<sqlQuery name="DbRefs_Gene">
			<column name="source_id"/>
			<column name="external_links"/>
			<column name="external_id"/>
			<sql>
				<![CDATA[
					 WITH links AS (
					 SELECT ga.source_id,
					 a.external_id,
					 string_agg('<a href="' || drl.url || a.external_id || '" class="wdk-toolitp" title="' || drl.resource_full_name || '">' || drl.resource_abbrev || '</a>', ' // ') AS external_links
					 FROM
					 CBIL.DbRefLink drl,
					 CBIL.GeneAttributes ga,
					 LATERAL jsonb_each(annotation),
					 LATERAL UNNEST(string_to_array(replace(value::text, '"',''), '|')) a(external_id)
					 WHERE drl.dbref_id = key
					 AND drl.resource_type = 'gene'
					 GROUP BY ga.source_id, a.external_id, '@PROJECT_ID@'::text
					 ORDER BY ga.source_id, a.external_id
					 )
					 SELECT source_id, 
					 external_id,
					 CASE WHEN external_id LIKE 'OTTMUS%' THEN replace(external_links, 'Homo_sapiens', 'Mus_musculus') ELSE external_links END AS external_links
					 FROM links
				]]>
			</sql>

		</sqlQuery>

		<sqlQuery name="DbRefs_Clinical">
			<column name="source_id"/>
			<column name="external_links"/>
			<column name="external_id"/>
			<sql>
				<![CDATA[
		 SELECT ga.source_id,
		 '@PROJECT_ID@'::text AS project_id,
		 a.external_id,
		 string_agg('<a href="' || drl.url || a.external_id || '" class="wdk-toolitp" title="' || drl.resource_full_name || '">' || drl.resource_abbrev || '</a>', ' // ') AS external_links
		 FROM
		 CBIL.DbRefLink drl,
		 CBIL.GeneAttributes ga,
		 LATERAL jsonb_each(annotation),
		 LATERAL UNNEST(string_to_array(replace(value::text, '"',''), '|')) a(external_id)
		 WHERE drl.dbref_id = key
		 AND drl.resource_type = 'clinical'
		 GROUP BY ga.source_id, a.external_id, '@PROJECT_ID@'::text
		 ORDER BY ga.source_id, a.external_id
	]]>
			</sql>
		</sqlQuery>

		<sqlQuery name="DbRefs_NSeq">
			<column name="source_id"/>
			<column name="external_links"/>
			<column name="external_id"/>
			<sql>
				<![CDATA[
		 SELECT ga.source_id,
		 '@PROJECT_ID@'::text AS project_id,
		 a.external_id,
		 string_agg('<a href="' || drl.url || a.external_id || '" class="wdk-toolitp" title="' || drl.resource_full_name || '">' || drl.resource_abbrev || '</a>', ' // ') AS external_links
		 FROM
		 CBIL.DbRefLink drl,
		 CBIL.GeneAttributes ga,
		 LATERAL jsonb_each(annotation),
		 LATERAL UNNEST(string_to_array(replace(value::text, '"',''), '|')) a(external_id)
		 WHERE drl.dbref_id = key
		 AND drl.resource_type = 'nucleotide sequences'
		 GROUP BY ga.source_id, a.external_id, '@PROJECT_ID@'::text
		 ORDER BY ga.source_id, a.external_id
	]]>
			</sql>
		</sqlQuery>

		<sqlQuery name="DbRefs_Proteins">
			<column name="source_id"/>
			<column name="external_links"/>
			<column name="external_id"/>
			<sql>
				<![CDATA[
		 SELECT ga.source_id,
		 '@PROJECT_ID@'::text AS project_id,
		 a.external_id,
		 string_agg('<a href="' || drl.url || a.external_id || '" class="wdk-toolitp" title="' || drl.resource_full_name || '">' || drl.resource_abbrev || '</a>', '  // ') AS external_links
		 FROM
		 CBIL.DbRefLink drl,
		 CBIL.GeneAttributes ga,
		 LATERAL jsonb_each(annotation),
		 LATERAL UNNEST(string_to_array(replace(value::text, '"',''), '|')) a(external_id)
		 WHERE drl.dbref_id = key
		 AND drl.resource_type = 'protein'
		 GROUP BY ga.source_id, a.external_id, '@PROJECT_ID@'::text
		 ORDER BY ga.source_id, a.external_id
	]]>
			</sql>
		</sqlQuery>
	</querySet>
</wdkModel>
