<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>
  <querySet name="study001_GeneTables" queryType="table" isCacheable="false">

    <!-- =================================================================== -->
    <!-- Comparisons: Study001 -->
    <!-- =================================================================== -->
    
    <sqlQuery name="WithinLineageComparisons">
      <column name="source_id"/>
      <column name="cell_or_lineage"/>
      <column name="ref_condition"/>
      <column name="alt_condition"/>
      <column name="dataset_name"/>
      <column name="dataset_id"/>
      <column name="ref_mean_expression"/>
      <column name="alt_mean_expression"/>
      <column name="fold_change"/>
      <column name="adj_p_value"/>
      <column name="confidence_interval"/>
      <sql>
	<![CDATA[
		 SELECT ga.source_id,
		 extract_lineage(pan.cell_or_lineage) AS cell_or_lineage,
		 pan.ref_condition,
		 pan.alt_condition,
		 round(r.mean1::numeric, 2) AS ref_mean_expression,
		 round(r.mean2::numeric, 2) AS alt_mean_expression,
		 round(r.fold_change::numeric, 2) AS fold_change,
		 
		 CASE WHEN r.adj_p_value < 0.0001 THEN to_char(r.adj_p_value, '9.99EEEE')
		 ELSE round(r.adj_p_value::numeric,4)::text
		 END AS adj_p_value,
		 
		 '[' || round(confidence_down::numeric, 2) || ', ' || round(confidence_up::numeric, 2) || ']' AS confidence_interval,
		 pan.name AS comparison,
		 p.investigation_id AS dataset_id,
		 p.dataset_name AS dataset_name 
		 
		 FROM ErythronDB.Comparison c,
		 Study.StudyLink sl,
		 Study.ProtocolAppNode pan,
		 ErythronDB.Dataset p,
		 Results.GeneDiffResult r,
		 CBIL.GeneAttributes ga
		 
		 WHERE sl.study_id = p.dataset_study_id
		 AND p.investigation_id = 'study001' AND NOT p.is_comprehensive
		 AND sl.protocol_app_node_id = c.protocol_app_node_id
		 AND c.protocol_app_node_id = pan.protocol_app_node_id
		 AND r.protocol_app_node_id = c.protocol_app_node_id
		 AND r.gene_id = ga.gene_id
		 AND r.adj_p_value <= 0.05
		 
		 ORDER BY fold_change DESC 
	]]>
      </sql>
    </sqlQuery>
    
    <sqlQuery name="AcrossLineageComparisons">
      <column name="source_id"/>
      <column name="cell_or_lineage"/>
      <column name="ref_condition"/>
      <column name="alt_condition"/>
      <column name="dataset_name"/>
      <column name="dataset_id"/>
      <column name="ref_mean_expression"/>
      <column name="alt_mean_expression"/>
      <column name="fold_change"/>
      <column name="adj_p_value"/>
      <column name="confidence_interval"/>
      <sql>
	<![CDATA[
		 SELECT ga.source_id,
		 pan.cell_or_lineage,
		 extract_lineage(pan.ref_condition) AS ref_condition,
		 extract_lineage(pan.alt_condition) AS alt_condition,
		 round(r.mean1::numeric, 2) AS ref_mean_expression,
		 round(r.mean2::numeric, 2) AS alt_mean_expression,
		 round(r.fold_change::numeric, 2) AS fold_change,
		 
		 CASE WHEN r.adj_p_value < 0.0001 THEN to_char(r.adj_p_value, '9.99EEEE')
		 ELSE round(r.adj_p_value::numeric,4)::text
		 END AS adj_p_value,
		 
		 '[' || round(confidence_down::numeric, 2) || ', ' || round(confidence_up::numeric, 2) || ']' AS confidence_interval,
		 pan.name AS comparison,
		 p.investigation_id AS dataset_id,
		 p.dataset_name AS dataset_name 
		 
		 FROM ErythronDB.Comparison c,
		 Study.StudyLink sl,
		 Study.ProtocolAppNode pan,
		 ErythronDB.Dataset p,
		 Results.GeneDiffResult r,
		 CBIL.GeneAttributes ga
		 
		 WHERE sl.study_id = p.dataset_study_id
		 AND p.investigation_id = 'study001' AND p.is_comprehensive
		 AND sl.protocol_app_node_id = c.protocol_app_node_id
		 AND c.protocol_app_node_id = pan.protocol_app_node_id
		 AND r.protocol_app_node_id = c.protocol_app_node_id
		 AND r.gene_id = ga.gene_id
		 AND r.adj_p_value <= 0.05
		 
		 ORDER BY fold_change DESC
	]]>
      </sql>
    </sqlQuery>
    
    <!-- =================================================================== -->
    <!-- Profiles: Study001 -->
    <!-- =================================================================== -->
    
    <sqlQuery name="ExpressionProfile">
      <column name="source_id" columnType="string"/>
      <column name="dataset_id" columnType="string"/>
      <column name="dataset_name" columnType="string"/>
      <column name="dataset_description" columnType="string"/>
      <column name="gene_profile" columnType="string"/>
      <column name="reporter_profile" columnType="string"/>
      <column name="avg_gene_profile" columnType="string"/>
      <sql>
	<![CDATA[

		 SELECT '@PROJECT_ID@'::text AS project_id, p.* FROM ErythronDB.GeneNotSampledProfile p,
		 (##WDK_ID_SQL##) id
		 WHERE p.source_id = id.source_id
		 AND dataset_id = 'study001'
		 
		 UNION ALL
		 
		 SELECT '@PROJECT_ID@'::text AS project_id, p.* FROM ErythronDB.GeneNotExpressedProfile p,
		 (##WDK_ID_SQL##) id
		 WHERE p.source_id = id.source_id
		 AND dataset_id = 'study001'
		 
		 UNION ALL
		 
		 SELECT '@PROJECT_ID@'::text AS project_id, p.* FROM ErythronDB.GeneExpressedProfile p,
		 (##WDK_ID_SQL##) id
		 WHERE p.source_id = id.source_id
		 AND dataset_id = 'study001'

		 ORDER BY order_num
	]]>
      </sql>
    </sqlQuery>
    
</querySet>
</wdkModel>
